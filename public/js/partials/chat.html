<main class="global-content">
  <div class="container" style="position: relative;">
    <nav class="side-nav index-nav" ng-if="!channel.selected.fullscreen">
      <ul class="affix">
        <li class="title-control">
          <div class="dropdown dropdown-select class="form-control" btn-group item-count-9" uib-dropdown>
            <a href="#" class="dropdown-toggle btn btn-default" data-toggle="dropdown" uib-dropdown-toggle>
              <span class="label">Canales disponibles</span> <i class="fa fa-fw fa-sort icon-caret"></i>
            </a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Canales públicos</li>
              <li ng-repeat="c in channels" ng-class="{active: c.name == channel.selected.name}">
                <a href="" ng-click="changeChannel(c)" title="{{ c.description }}">
                  <span class="icon category-icon" ng-class="{'uncategorized': !c.color}" ng-style="{background: c.color}"></span> {{ c.name }}
                </a>
              </li>
            </ul>
          </div>
        </li>
      </ul>
    </nav>

    <div class="offset-content" ng-class="{'details-open': show_details, 'stream-chat': channel.selected.fullscreen}">
      <div class="index-toolbar">
        <div class="index-toolbar-action">
          <div class="row">
            <div class="col-md-6 col-xs-7">
              <h3 style="margin-top: 0">{{ channel.selected.name || "#" }}</h3>
            </div>
            <div class="col-md-6 col-xs-5 text-right">
              <a title="Información de este canal" class="btn btn-default btn-icon btn-round hidden" ng-click="toggle_details()" ng-class="{'active': show_details}">
                <i class="fa fa-fw fa-info-circle icon"></i>
                <span class="label hidden-xs">Información de este canal</span>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div adjust-height-chat>
        <div class="message-history">
          <div class="message" ng-repeat="m in old_messages" ng-class="::{'compact':old_messages[$index-1].author.username == old_messages[$index].author.username}">
            <a href="/u/{{ m.author.username }}/{{ m.author.id }}" class="author" target="_blank" ng-if=":: old_messages[$index-1].author.username != m.author.username">
              <span class="avatar" title="{{ m.author.username }}" ng-if="!m.author.image">{{ m.author.username[0] }}</span>
              <img class="avatar" ng-src="{{ m.author.image }}" alt="{{ m.author.username }}" ng-if="m.author.image">
            </a>
            <div class="meta" ng-if=":: old_messages[$index-1].author.username != m.author.username">
              <a href="/u/{{ m.author.username }}/{{ m.author.id }}" class="username" target="_blank">{{ m.author.username }}</a>
              <span class="timestamp" uib-tooltip="{{ m.created_at | date_at }}" tooltip-popup-delay="500" tooltip-placement="right">{{ m.created_at | date:'H:mm' }}</span>
              <span class="star"></span>
            </div>
            <span class="timestamp" ng-if=":: old_messages[$index-1].author.username == m.author.username" uib-tooltip="{{ m.created_at | date_at }}" tooltip-popup-delay="500" tooltip-placement="right">{{ m.created_at | date:'H:mm' }}</span>
            <div class="content">{{ m.content }}</div>
          </div>
          <div class="message" ng-repeat="m in messages" ng-class="::{'compact':messages[$index-1].author.username == messages[$index].author.username, 'message-highlight': m.highlight}">
            <a href="/u/{{ m.author.username }}/{{ m.author.id }}" class="author" target="_blank" ng-if=":: messages[$index-1].author.username != m.author.username">
              <span class="avatar" title="{{ m.author.username }}" ng-if="!m.author.image">{{ m.author.username[0] }}</span>
              <img class="avatar" ng-src="{{ m.author.image }}" alt="{{ m.author.username }}" ng-if="m.author.image">
            </a>
            <div class="meta" ng-if=":: messages[$index-1].author.username != m.author.username">
              <a href="/u/{{ m.author.username }}/{{ m.author.id }}" class="username" target="_blank">{{ m.author.username }}</a>
              <span class="timestamp" uib-tooltip="{{ m.created_at | date_at }}" tooltip-popup-delay="500" tooltip-placement="right">{{ m.created_at | date:'H:mm' }}</span>
              <span class="star"></span>
            </div>
            <span class="timestamp" ng-if=":: messages[$index-1].author.username == messages[$index].author.username" uib-tooltip="{{ m.created_at | date_at }}" tooltip-popup-delay="500" tooltip-placement="right">{{ m.created_at | date:'H:mm' }}</span>
            <div show-images content="{{ m.content }}" username="{{ user.info.username }}" class="content"></div>
          </div>

          <div class="new_chat_alert" ng-if="scroll_help.scrolledUp && old_messages.length > 0"><a href="" ng-click="goToBottom()"><i class="fa fa-arrow-down"></i> Nuevos mensajes ({{ old_messages.length }})</a></div>
        </div>

        <div class="footer">
          <div class="input-box" ng-if="user.isLogged">

            <div emoji-form emoji-message="emojiMessage" sg-enter="addMessage()">
              <textarea id="messageInput" class="input-box_text" ng-model="emojiMessage.messagetext" mentio mentio-typed-text="typedTerm" mentio-items="people | filter:label:typedTerm"></textarea>

              <button id="emojibtn" class="emoji-pop-btn">
                <i class="icon icon-emoji"></i>
              </button>
            </div>
            <div class="row">
              <div class="col-md-8">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" ng-model="message.send_on_enter"> Presionar 'Enter' para mandar el mensaje
                  </label>
                </div>
                <div class="checkbox" ng-if="can('delete-category-comments')">
                  <label>
                    <input type="checkbox" ng-model="message.highlight"> Resaltar mensajes (para moderación)
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <span class="input-group-btn" ng-if="!message.send_on_enter" style="text-align: right;">
                  <button class="btn btn-primary btn-send" type="button" ng-click="addMessage()"><span class="label">Enviar</span></button>
                </span>
              </div>
            </div>
          </div>
          <div class="input-box" ng-if="!user.isLogged">
            <p class="alert alert-warning">Necesitas crear una cuenta para participar. <a href="" ng-click="signUp()">Regístrate</a> o <a href="" ng-click="signIn()">inicia sesión</a> si ya tienes una.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="details-nav" ng-if="show_details" ng-class="{stream: channel.selected.fullscreen}">
      <div class="detail-section" ng-if="channel.selected.fullscreen && !channel.selected.fullscreen.video">
        <img ng-src="{{ channel.selected.fullscreen.image }}" width="100%">
      </div>

      <div class="detail-section" ng-if="channel.selected.fullscreen.video">
        <youtube code="channel.selected.fullscreen.video"></youtube>
      </div>

      <div class="detail-section" ng-if="can('board-config')">
        <h4>Configuración</h4>
        <form class="form-inline">
          <div class="form-group">
            <label for="yt-code">Código de Youtube</label>
            <input type="text" class="form-control" id="yt-code" placeholder="abcde123" ng-model="channel.selected.new_yt_code">
          </div>
          <button type="submit" class="btn btn-default" ng-click="updateChannelMeta()">Actualizar video</button>
        </form>
      </div>

      <div class="detail-section">
        <h4>Información del canal</h4>
        <p ng-bind="channel.selected.description"></p>
      </div>

      <div class="detail-section" ng-if="!channel.selected.fullscreen || true">
        <h4>Spartanos conectados</h4>

        <input type="text" ng-model="searchText.content" class="form-control mb-20" ng-if="can('edit-category-comments')">

        <ul class="user-status">
          <li ng-repeat="m in members | filter:searchText.content | orderBy:['-status','username']" ng-class="{'online': m.status == 'online'}">
            <a href="/u/{{ m.username }}/{{ m.id }}" class="">
              <span class="avatar" title="{{ m.username }}" ng-if="!m.image">{{ m.username[0] }}</span>
              <img class="avatar" ng-src="{{ m.image }}" alt="{{ m.username }}" ng-if="m.image">
            </a>
            <a href="/u/{{ m.username }}/{{ m.id }}" class="username">{{ m.username }}</a>

            <span ng-if="m.id != user.info.id && can('edit-category-comments')" ng-click="m.hide_info = !m.hide_info"><i class="fa fa-ban"></i></span>
            <span class="status"></span>

            <div uib-collapse="!m.hide_info" ng-if="m.id != user.info.id && can('edit-category-comments')" style="padding: 10px 0; border-bottom: 1px solid #ddd;">
              <div class="btn-toolbar">
                <a href="" ng-click="suspendUser(m.id, 60*5); m.already_blocked = true" class="btn btn-default btn-sm" ng-class="{'disabled': m.already_blocked}">Bloquear</a>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</main>